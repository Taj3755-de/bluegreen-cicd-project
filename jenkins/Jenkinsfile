pipeline {
    agent any

    environment {
        APP_NAME        = "finacplus-app"
        IMAGE_REPO      = "157314643992.dkr.ecr.us-east-1.amazonaws.com/finacplus"
        KUBE_NAMESPACE  = "default"
        DEPLOYMENT_BLUE = "finacplus-blue"
        DEPLOYMENT_GREEN = "finacplus-green"
        SERVICE_NAME    = "finacplus-service"
        HEALTH_ENDPOINT = "/actuator/health"
        AWS_REGION      = "us-east-1"
    }

    stages {

        /**********************
         * 1. CHECKOUT CODE
         **********************/
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/your-org/your-repo.git'
            }
        }

        /**********************
         * 2. BUILD & PUSH IMAGE
         **********************/
        stage('Build & Push') {
            steps {
                sh """
                    aws ecr get-login-password --region ${AWS_REGION} \
                      | docker login --username AWS --password-stdin ${IMAGE_REPO}

                    docker build -t ${APP_NAME}:${BUILD_NUMBER} .
                    docker tag ${APP_NAME}:${BUILD_NUMBER} ${IMAGE_REPO}:${BUILD_NUMBER}
                    docker push ${IMAGE_REPO}:${BUILD_NUMBER}
                """
            }
        }

        /**********************
         * 3. BLUE OR GREEN â€“ DECISION
         *    Only one is ACTIVE.
         **********************/
        stage('Determine Active Color') {
            steps {
                script {
                    def blueExists = sh(script: "kubectl get deploy ${DEPLOYMENT_BLUE} -n ${KUBE_NAMESPACE} --ignore-not-found", returnStdout: true).trim()
                    def greenExists = sh(script: "kubectl get deploy ${DEPLOYMENT_GREEN} -n ${KUBE_NAMESPACE} --ignore-not-found", returnStdout: true).trim()

                    if (blueExists) {
                        println "BLUE currently exists. GREEN will be deployed."
                        env.TARGET = "green"
                    } else if (greenExists) {
                        println "GREEN exists. BLUE will be deployed."
                        env.TARGET = "blue"
                    } else {
                        println "No deployments found. BLUE will be deployed first."
                        env.TARGET = "blue"
                    }
                }
            }
        }

        /**********************
         * 4. DEPLOY TARGET COLOR
         **********************/
        stage('Deploy Target Color') {
            steps {
                script {
                    if (env.TARGET == "blue") {
                        sh """
                            kubectl apply -n ${KUBE_NAMESPACE} -f k8s/blue-deployment.yaml \
                                --record=true
                            kubectl set image deployment/${DEPLOYMENT_BLUE} \
                                ${APP_NAME}=${IMAGE_REPO}:${BUILD_NUMBER} -n ${KUBE_NAMESPACE}
                        """
                    } else {
                        sh """
                            kubectl apply -n ${KUBE_NAMESPACE} -f k8s/green-deployment.yaml \
                                --record=true
                            kubectl set image deployment/${DEPLOYMENT_GREEN} \
                                ${APP_NAME}=${IMAGE_REPO}:${BUILD_NUMBER} -n ${KUBE_NAMESPACE}
                        """
                    }
                }
            }
        }

        /**********************
         * 5. HEALTH CHECK TARGET
         **********************/
        stage('Health Check') {
            steps {
                script {
                    def deployment = env.TARGET == "blue" ? DEPLOYMENT_BLUE : DEPLOYMENT_GREEN

                    sh """
                        echo "Waiting for pods to be ready..."
                        kubectl rollout status deploy/${deployment} -n ${KUBE_NAMESPACE} --timeout=60s
                    """

                    // Call service pod to verify health
                    sh """
                        POD=\$(kubectl get pods -n ${KUBE_NAMESPACE} -l app=${APP_NAME},color=${env.TARGET} -o jsonpath='{.items[0].metadata.name}')
                        for i in {1..10}; do
                            STATUS=\$(kubectl exec -n ${KUBE_NAMESPACE} \$POD -- curl -s http://localhost:8080${HEALTH_ENDPOINT} | jq -r '.status')
                            if [ "\$STATUS" = "UP" ]; then
                                echo "Health Check Passed"
                                exit 0
                            fi
                            echo "Retrying health check..."
                            sleep 5
                        done
                        echo "Health check FAILED"
                        exit 1
                    """
                }
            }
        }

        /**********************
         * 6. PROMOTE (SWITCH TRAFFIC)
         **********************/
        stage('Promote Deployment') {
            steps {
                script {
                    if (env.TARGET == "blue") {
                        sh """
                            kubectl patch svc ${SERVICE_NAME} -n ${KUBE_NAMESPACE} \
                              -p '{"spec":{"selector":{"app":"${APP_NAME}","color":"blue"}}}'
                        """
                    } else {
                        sh """
                            kubectl patch svc ${SERVICE_NAME} -n ${KUBE_NAMESPACE} \
                              -p '{"spec":{"selector":{"app":"${APP_NAME}","color":"green"}}}'
                        """
                    }
                }
            }
        }
    }

    /**********************
     * 7. ROLLBACK ON FAILURE
     **********************/
    post {
        failure {
            script {
                echo "Deployment Failed. Rolling back..."

                if (env.TARGET == "blue") {
                    sh """
                        kubectl patch svc ${SERVICE_NAME} -n ${KUBE_NAMESPACE} \
                          -p '{"spec":{"selector":{"app":"${APP_NAME}","color":"green"}}}'
                    """
                } else {
                    sh """
                        kubectl patch svc ${SERVICE_NAME} -n ${KUBE_NAMESPACE} \
                          -p '{"spec":{"selector":{"app":"${APP_NAME}","color":"blue"}}}'
                    """
                }

                echo "Rollback complete. Blue-Green pipeline protected."
            }
        }
    }
}
